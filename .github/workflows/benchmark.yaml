name: NativeLink Benchmarks

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  benchmark:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pymongo matplotlib pandas requests

      - name: Get previous commit
        id: get-prev-commit
        run: |
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            echo "prev_commit=${{ github.event.pull_request.base.sha }}" >> $GITHUB_OUTPUT
          else
            echo "prev_commit=$(git rev-parse HEAD~1)" >> $GITHUB_OUTPUT
          fi

      - name: Run Benchmarks
        run: |
          python benchmark/run_benchmarks.py \
            --commit=${{ github.sha }} \
            --compare-to=${{ steps.get-prev-commit.outputs.prev_commit }} \
            --output-dir=./benchmark_results

      - name: Upload results to database
        run: |
          python benchmark/db_uploader.py \
            --results-dir=./benchmark_results \
            --db-uri=${{ secrets.BENCHMARK_DB_URI }}

      - name: Generate reports
        run: |
          python benchmark/report_generator.py \
            --results-dir=./benchmark_results \
            --output-dir=./benchmark_reports

      - name: Upload benchmark results
        uses: actions/upload-artifact@v3
        with:
          name: benchmark-results
          path: benchmark_results/

      - name: Upload benchmark reports
        uses: actions/upload-artifact@v3
        with:
          name: benchmark-reports
          path: benchmark_reports/

      - name: Send Slack notification
        if: always()
        run: |
          python benchmark/slack_notifier.py \
            --commit=${{ github.sha }} \
            --results-dir=./benchmark_results \
            --webhook-url=${{ secrets.SLACK_WEBHOOK_URL }} \
            --repo=${{ github.repository }} \
            --run-id=${{ github.run_id }}